#!/bin/sh
# Wrapper for canoe
# You can add extra command line arguments to all games at once
# using "cfg_snes_extra_args" variable in p0000_config

source /etc/preinit
script_init

options=""
play_mode=""
game_title_code=""
output_rollback_dir=""
retroarch=0

while [ $# -gt 0 ] ; do
  case "$1" in
  -rom)
    filename="$(readlink -f "$2")"
    filebase="$(basename "$filename")"
    extension="${filebase##*.}"
    tmppath="$temppath/rom"
    if [ "$extension" == "7z" ]; then
      rm -rf "$tmppath"
      mkdir -p "$tmppath"
      cd "$tmppath"
      tiny7zx x "$filename"
      filename="$tmppath/$(ls)"
      filename_str=${filename// /_}
      mv "$filename" "$filename_str"
      filename=$filename_str
    fi
    options="-rom $filename"
    shift
    ;;
  --rollback-input-dir)
    if [ -f "$2/rollback.7z" ]; then
      rm -rf /tmp/rollback/
      mkdir -p /tmp/rollback/
      cd /tmp/rollback/
      tiny7zx x "$2/rollback.7z"
      options="$options $1 /tmp/rollback/"
    else
      options="$options $1 $2"
    fi
    shift
    ;;
  --rollback-output-dir)
    output_rollback_dir="$2"
    options="$options $1 $2"
    shift
    ;;
  --rollback-mode)
    play_mode="$2"
    options="$options $1 $2"
    shift
    ;;
  --title-code)
    game_title_code="$2"
    options="$options $1 $2"
    shift
    ;;
  --retroarch|-retroarch)
    retroarch=1
    options="$options $1"
    ;;
  *) options="$options $1" ;;
  esac
  shift
done

if [ $retroarch = 0 ]; then
  if [ $play_mode = "record" ]; then
    if [ -n $output_rollback_dir ]; then
      snes-save-compress "$play_mode" "$output_rollback_dir" &
    fi
  fi
  if [ $play_mode = "replay" ]; then
    if [ -n $game_title_code ] && [ -n $output_rollback_dir ]; then
      snes-save-compress "$play_mode" "$output_rollback_dir" "$game_title_code" &
    fi
  fi
fi

args="$options $cfg_snes_extra_args"
exec /usr/bin/clover-canoe-shvc $args
